<div id="calendar-header" class="flex flex-column">
  <common-calendar-header [viewDate]="viewDate" [view]="view">
    @if (view === CalendarView.Month){
    <div class="col flex justify-content-end">
      <p-button [outlined]="true" severity="danger">
        <span class="material-icons mr-2">today</span>
        <div
          mwlCalendarToday
          [(viewDate)]="viewDate"
          (mwlClick)="scrollToCurrentHour()"
        >
          Today
        </div>
      </p-button>
    </div>

    } @else {
    <div class="col-2 flex justify-content-end">
      <p-knob
        [(ngModel)]="displayKnobValue"
        [size]="70"
        [readonly]="true"
        [max]="100"
        [valueColor]="knobColor"
        strokeWidth="4"
      />
    </div>
    }
  </common-calendar-header>

  <div
    class="tab-group-container"
    cdkDropList
    (cdkDropListDropped)="drop($event)"
  >
    <div class="tab-group p-1">
      @for (tab of tabs; track tab){
      <div
        class="tab pt-2 pb-1"
        cdkDrag
        (click)="setView(tab.view)"
        [class.active]="view === tab.view"
      >
        <div class="flex flex-row align-items-center justify-content-center">
          <div class="material-icons p-2 vertical-align-middle text-base">
            {{ tab.icon }}
          </div>
          <div>{{ tab.label }}</div>
        </div>
      </div>
      }
    </div>
  </div>

  <div
    class="flex justify-content-between align-items-center mx-3 mt-1"
    *ngIf="view === CalendarView.Day"
  >
    <h5 class="font-bold">My habits</h5>
    <!-- switch che passa alla view Day o ToDo -->
    <p-inputSwitch
      styleClass="flex input-switch-day-todo"
      [(ngModel)]="switchDayView"
      (onChange)="setView(CalendarView.Day)"
    />
  </div>
</div>

<div>
  <div [ngSwitch]="view">
    <div #swipeContainer class="swipe-container mb-3">
      <div class="px-3">
        <mwl-calendar-month-view
          *ngSwitchCase="CalendarView.Month"
          [viewDate]="viewDate"
          [events]="events"
          [refresh]="refresh"
          [activeDayIsOpen]="activeDayIsOpen"
          (dayClicked)="dayClicked($event.day)"
          (eventTimesChanged)="eventTimesChanged($event)"
          [openDayEventsTemplate]="customOpenDayEventsTemplate"
          (beforeViewRender)="beforeMonthViewRender()"
          [cellTemplate]="customCellTemplate"
        >
          <ng-template
            #customOpenDayEventsTemplate
            let-events="events"
            let-isOpen="isOpen"
          >
            @if (isOpen){
            <div class="cal-open-day-events">
              <ng-container>
                @for (event of events; track event){
                <div class="event-container">
                  <!-- Icon and background color -->
                  <div
                    class="event-icon-container border-round-sm"
                    [style.backgroundColor]="event.color.primary"
                  >
                    <span class="material-icons text-base">{{
                      event.category.icon
                    }}</span>
                  </div>

                  <!-- Category and title -->
                  <div class="event-details">
                    <div class="event-category text-base">
                      {{ event.category.label }}
                    </div>
                    <div class="event-title text-base">{{ event.title }}</div>
                  </div>

                  <!-- Edit icon -->
                  <div class="edit-icon">
                    <p-knob
                      [(ngModel)]="event.actualGoal"
                      [size]="50"
                      [readonly]="true"
                      (click)="showDialog(event)"
                      [max]="
                        event.actualGoal > event.goal
                          ? event.actualGoal
                          : event.goal
                      "
                      [valueColor]="event | calculateKnobColor"
                      strokeWidth="4"
                    />
                  </div>
                </div>
                }
              </ng-container>
            </div>
            }
          </ng-template>

          <ng-template #customCellTemplate let-day="day" let-locale="locale">
            @if (day){
            <div
              class="cal-cell-top flex flex-column align-items-center justify-content-between"
            >
              <div class="cal-day-number text-center flex align-items-center">
                <span
                  class="cal-day-badge mt-0 mr-1"
                  *ngIf="day.badgeTotal > 0"
                >
                  {{ day.badgeTotal }}
                </span>
                {{ day.date | calendarDate : "monthViewDayNumber" : locale }}
              </div>
              <div>
                <p-knob
                  [ngModel]="day.events | calculateKnobValue"
                  [size]="40"
                  [readonly]="true"
                  [max]="100"
                  [valueColor]="day.events | calculateKnobColor"
                  strokeWidth="4"
                />
              </div>
            </div>

            }
          </ng-template>
        </mwl-calendar-month-view>
      </div>
    </div>
    <div *ngSwitchCase="CalendarView.Day">
      @if (viewDate && events && switchDayView){
      <mwl-calendar-day-view
        [viewDate]="viewDate"
        [events]="events"
        [refresh]="refresh"
        (eventTimesChanged)="eventTimesChanged($event)"
        [eventTemplate]="eventDayTemplate"
      >
      </mwl-calendar-day-view>
      } @else if (!switchDayView) {
      <app-todo-habits-view class="mb-3" (updatedHabits)="updateHabits($event)">
        ></app-todo-habits-view
      >
      }
    </div>
  </div>
</div>

<ng-template #eventDayTemplate let-event="weekEvent.event">
  @if (event){
  <div
    class="cal-event grid overflow-scroll bg-primary"
    (click)="showDialog(event)"
  >
    <div class="col" [class.py-1]="event.allDay">
      <div class="cal-event-header flex align-items-center">
        <div
          class="icon-container border-round flex align-items-center justify-content-center mr-2"
          style="width: 2rem; height: 2rem"
          [style.background-color]="event.color.primary"
          [style.color]="event.color.secondary"
        >
          <span
            class="material-icons category-icon"
            [class.text-base]="!event.allDay"
            [class.text-xs]="event.allDay"
            [style.color]="event.color.secondary"
            >{{ event.category.icon }}</span
          >
        </div>
        <div
          class="category-label line-height-1"
          [class.text-sm]="!event.allDay"
          [class.text-xs]="event.allDay"
        >
          {{ event.category.label }}
          <div
            class="cal-event-title"
            [class.text-sm]="!event.allDay"
            [class.text-xs]="event.allDay"
          >
            {{ event.title }}
          </div>
        </div>
      </div>
    </div>
    <!-- knob -->
    <div class="cal-event-knob p-0 col flex justify-content-end">
      <div class="flex justify-content-center align-items-center line-height-1">
        <div class="mr-1">
          <div class="text-xs">
            Goal: {{ event.goal | formatNumber }}
            <div class="text-xs">
              {{
                event.goalType === "custom"
                  ? event.customGoalType
                  : event.goalType
              }}
            </div>
          </div>
        </div>

        <p-knob
          [(ngModel)]="event.actualGoal"
          [size]="event.allDay ? 30 : 40"
          [readonly]="true"
          [max]="event.actualGoal > event.goal ? event.actualGoal : event.goal"
          [valueColor]="event | calculateKnobColor"
          strokeWidth="4"
        />
      </div>
    </div>
  </div>
  }
</ng-template>

@defer{
<app-actual-goal-modal
  [visible]="visible"
  (hide)="hideDialog($event)"
  [currentHabit]="currentHabit"
  (confirmEventEmitter)="updateActualGoal($event)"
  (editHabitEmitter)="handleEvent($event)"
></app-actual-goal-modal>
}
